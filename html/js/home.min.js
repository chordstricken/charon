function get_path(){return location.hash.replace(/^[\#\!]{1,2}/,"")}var Charon=angular.module("Charon",["angular-sortable-view"]);(location.pathname.length>1||location.search.length||location.hash.length<2)&&(location.href="/#/"),$(document).on("mouseover","[data-toggle=popover]",function(){$(this).data("bs.popover")||($(this).popover({placement:"top",delay:{show:700,hide:100},trigger:"hover"}),$(this).trigger("mouseover"))}),Charon.controller("Home",function($scope,$http,$location,$timeout){$scope.loader=!1,$scope.success="",$scope.error="",$scope.has_changed=!1,$scope.object_hash=!1,$scope.icons=["fa-key","fa-terminal","fa-database","fa-lock","fa-rocket","fa-truck","fa-envelope-square","fa-book","fa-heartbeat","fa-certificate","fa-expeditedssl","fa-slack","fa-wordpress","fa-linux","fa-apple","fa-android","fa-amazon","fa-windows","fa-instagram","fa-dropbox","fa-google-plus-square","fa-facebook-square","fa-twitter","fa-yelp","fa-ban"],$scope.timeouts={},$scope.query="",$scope.index={},$scope.reset_object=function(){$scope.object={id:"",name:"",note:"",items:[]},$scope.add_item(),$scope.has_changed=!1,$scope.object_hash=md5(JSON.stringify($scope.object))},$scope.clear_messages=function(){$scope.error=$scope.success=""},$scope.add_item=function(){$scope.object.items.push({_id:unique_id(),icon:"fa-key",title:"",user:"",pass:"",note:""})},$scope.remove_item=function(key){$scope.object.items.splice(key,1)},$scope.highlight=function($event){setTimeout(function(){$($event.target).select()},10)},$scope.set_mask=function($event,mask){$event.target.type=type},$scope.load_index=function(){$http.get("/_index").success(function(data){$scope.index=decrypt(data,localStorage.pass)}).error(function(data,code){return 401==code?void location.reload():void($scope.error=data)})},$scope.save_object=function(){$scope.toggle_loader(!0),$scope.clear_messages();var enc_obj=encrypt($scope.object,localStorage.pass);$http.post("/"+$scope.object.id,enc_obj).success(function(data){$scope.object=decrypt(data,localStorage.pass),location.hash="#/"+$scope.object.id,$scope.load_index(),$scope.toggle_loader(!1),$scope.has_changed=!1,$scope.object_hash=md5(JSON.stringify($scope.object)),$scope.success="Successfully saved the object"}).error(function(data,code){return 401==code?void location.reload():($scope.error=data,void $scope.toggle_loader(!1))})},$scope.delete_object=function(){$scope.toggle_loader(!0),$scope.clear_messages(),$http.delete("/"+$scope.object.id).success(function(data){$scope.success=data,$scope.reset_object(),$scope.load_index(),$scope.toggle_loader(!1)}).error(function(data,code){return 401==code?void location.reload():($scope.error=data,void $scope.toggle_loader(!1))})},$scope.load_object=function(){$scope.toggle_loader(!0),$scope.clear_messages();var path=get_path();return"/"==path?($scope.toggle_loader(!1),void $scope.reset_object()):void $http.get(path).success(function(data){var dec_obj=decrypt(data,localStorage.pass);dec_obj.items.map(function(item){void 0===item._id&&(delete item.$$hashKey,item._id=unique_id()),item.icon=item.icon&&item.icon.length?item.icon:"fa-key"}),$scope.object=dec_obj,$scope.object_hash=md5(JSON.stringify($scope.object)),$scope.has_changed=!1,$scope.toggle_loader(!1)}).error(function(data,code){return 401==code?void location.reload():($scope.error=data,$scope.toggle_loader(!1),void $scope.reset_object())})},$scope.toggle_loader=function(toggle){toggle?$scope.timeouts.loader=$timeout(function(){$scope.loader=!0},200):($scope.loader=!1,$timeout.cancel($scope.timeouts.loader),window.scrollTo(0,0))},$scope.logout=function(){$http.get("/logout").success(function(){location.reload()}).error(function(){location.reload()})},$scope.generate_password=function(index){for(var chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&*_-?",pass="",i=0;i<16;i++){var key=Math.floor(Math.random()*chars.length);pass+=chars[key]}$scope.object.items[index].pass=pass},$scope.search=function(id){if($scope.query.length<3)return!0;var regexp=new RegExp($scope.query.replace(" ",".*"),"i");if(null!==$scope.index[id].name.match(regexp))return!0;if(void 0!==$scope.index[id].meta)for(var i in $scope.index[id].meta)if($scope.index[id].meta[i].match&&null!==$scope.index[id].meta[i].match(regexp))return!0;return!1},$scope.field_match=function(value){if(!$scope.query.length)return!1;var regexp=new RegExp($scope.query.replace(" ",".*"),"i");return null!==value.match(regexp)},$scope.navigate=function($event,key){return key===!1?38!==$event.keyCode&&40!==$event.keyCode||void 0===$scope.index[0]||(location.hash="/"+$scope.index[0].id):38===$event.keyCode?(key=void 0!==$scope.index[key-1]?key--:$scope.index.length-1,$location.hash="/"+$scope.index[key].id):40===$event.keyCode&&(key=void 0!==$scope.index[key+1]?key++:0,$location.hash="/"+$scope.index[key].id),!1},$scope.load_timeout=function(){$scope.load_index(),$scope.timeouts.index=$timeout($scope.load_timeout,36e5)},$scope.load_timeout(),$scope.$on("$locationChangeStart",function(e){$scope.has_changed&&(window.confirm("It looks like you have been editing something. Would you like to leave anyway?")||(e.preventDefault(),"activeElement"in document&&document.activeElement.blur()))}),$scope.$on("$locationChangeSuccess",function(){$scope.load_object()}),$scope.$watch("object",function(){if($scope.object_hash){var hash=md5(JSON.stringify($scope.object));$scope.has_changed=$scope.object_hash!==hash}},!0),get_cookie("PHPSESSID")||$scope.logout(),window.addEventListener("beforeunload",function(e){if($scope.has_changed){var confirmationMessage="It looks like you have been editing something. If you leave before saving, your changes will be lost.";return(e||window.event).returnValue=confirmationMessage,confirmationMessage}})}),$(document).on("focus",".password-mask",function(){$(this).attr("type","text")}),$(document).on("blur",".password-mask",function(){$(this).attr("type","password")}),$(document).on("keyup",function(e){if(!e.target.value)switch(e.keyCode){case 27:document.activeElement&&document.activeElement.blur();break;case 191:$("#search").focus()}}),$(document).on("keyup","#search",function(e){13===e.keyCode&&$(".nav-sidebar a[href]").eq(1).trigger("click")});